---
title: |
  ![](Meteo.png){width=75%}  
  Prévision météorologique sur la Ville de Tours
author: 
- Charles Vitry
- Clovis Deletre
date: "[Régression Linéaire Multiple](https://fr.wikipedia.org/wiki/R%C3%A9gression_lin%C3%A9aire_multiple)"
output:
  rmarkdown::html_document:
    theme: cerulean
    number_sections: no
    toc: yes
    toc_depth: 5
    toc_float: true
---

<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
  color: DarkBlue;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 18px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 15px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install for export in pdf file
#tinytex::install_tinytex()
```

## Présentation des données

Nous étions à la recherche d'un **jeu de données** de minimum 300 observations et 15 variables quantitatives dont une à expliquer,
Nous avions des jeux de données provenant de sondages, mais leurs données étaient qualitative, donc non exploitable dans notre contexte d'étude.

Après recherche, le jeu de données choisis est météorologique, nous allons expliquer la température en fonction des autres variables quantitative. Ce jeu de données a été obtenu dans les open data de la ville de Tours, le fichier est trouvable à l'adresse suivante : <https://data.tours-metropole.fr/explore/dataset/observation-meteorologique-historiques-tours-synop/export/?sort=date>.

# Import de la base de données
```{r}
data <- 
  read.csv("~/PrevisionMeteoTours/observation-meteorologique-historiques-tours-synop.csv", sep=";")

```

D'après l'hébergeur les paramètres atmosphériques sont mesurés (température, humidité, direction et force du vent, pression atmosphérique, hauteur de précipitations) ou observés (temps sensible, description des nuages, visibilité) depuis la surface terrestre.

Après lecture de la colonne Date, les données sont collectés de 2010 jusqu'à maintenant, il en résulte plus de \textcolor{blue}{30k observations}.


\newpage
Nous avpns cependant une limite à notre analyse.
Puisque l'ensemble de ces observations est tirés d'une seule station d'observation.
![Data_Location.png](Data_Location.png){width=50%}

Nous supprimons alors les collonnes correspondant à des indications géographiques
```{r}
#numero de la station météo
data$ID.OMM.station <- NULL

#coords géographique
data$Coordonnees <- NULL
data$Latitude <- NULL
data$Longitude <- NULL

#Nom de la ville et département
data$Nom <- NULL
data$communes..code. <- NULL
data$communes..name. <- NULL
data$EPCI..name. <- NULL
data$EPCI..code. <- NULL
data$department..name. <- NULL
data$department..code. <- NULL
data$region..name. <- NULL
data$region..code.<- NULL
```

Les colonnes vides ou constantes sont inutilisables
```{r}
data$Niveau.baromÃ.trique  <- NULL
data$TempÃ.rature.minimale.sur.24.heures <- NULL
data$TempÃ.rature.minimale.sur.24.heures..Â.C. <- NULL
data$MÃ.thode.de.mesure.TempÃ.rature.du.thermomÃ.tre.mouillÃ. <- NULL
data$TempÃ.rature.du.thermomÃ.tre.mouillÃ. <- NULL
data$Hauteur.totale.de.la.couche.de.neige..glace..autre.au.sol <- NULL
data$NÃ.bulositÃ..couche.nuageuse.4 <- NULL
data$Hauteur.de.base.4 <- NULL
data$TempÃ.rature.minimale.sur.24.heures <- NULL
data$TempÃ.rature.maximale.sur.24.heures <- NULL
data$Altitude  <- NULL
data$NÃ.bulositÃ..couche.nuageuse.1  <- NULL
data$Etat.du.sol  <- NULL
data$Periode.de.mesure.de.la.rafale  <- NULL
data$NÃ.bulositÃ...des.nuages.de.l..Ã.tage.infÃ.rieur  <- NULL
data$TempÃ.rature.minimale.du.sol.sur.12.heures..en.Â.C. <- NULL

```


Retirons les variables qualitatives

type de tendance barométrique et temps présent est mis quali- mi quanti, nous ne le traitons pas
```{r}
data$Type.de.tendance.baromÃ.trique <- NULL
data$Temps.prÃ.sent <- NULL
data$Temps.prÃ.sent.1 <- NULL
data$Temps.passÃ..1 <- NULL
data$Temps.passÃ..1.1 <- NULL
data$Temps.passÃ..2 <- NULL
data$Type.de.tendance.baromÃ.trique.1 <- NULL
data$mois_de_l_annee <- NULL



```



Nous n'avons pas supprimé la variable date car elle nous est utile à trier chronologiquement les données.
```{r,echo=TRUE}

data <- data[order(as.Date(data$Date)),]

```

Observons les valeurs manquantes des variables restantes
Existe t'il une fonction pour tester toutes les variables ?
```{r}
#1
sum(is.na(data$Pression.au.niveau.mer))
#2
sum(is.na(data$Variation.de.pression.en.3.heures))
#3
sum(is.na(data$Type.de.tendance.baromÃ.trique))
#4
sum(is.na(data$Direction.du.vent.moyen.10.mn))
#5
sum(is.na(data$Vitesse.du.vent.moyen.10.mn))
#6
sum(is.na(data$TempÃ.rature))
#7
sum(is.na(data$Point.de.rosÃ.e))
#8
sum(is.na(data$HumiditÃ.))
#9
sum(is.na(data$VisibilitÃ..horizontale))
#10
sum(is.na(data$NebulositÃ..totale))
#11
sum(is.na(data$NÃ.bulositÃ...des.nuages.de.l..Ã.tage.infÃ.rieur))
#12
sum(is.na(data$Hauteur.de.la.base.des.nuages.de.l.Ã.tage.infÃ.rieur))
#13
sum(is.na(data$Type.des.nuages.de.l.Ã.tage.infÃ.rieur))
#14
sum(is.na(data$Type.des.nuages.de.l.Ã.tage.moyen))
#15
sum(is.na(data$Type.des.nuages.de.l.Ã.tage.supÃ.rieur))
#16
sum(is.na(data$Pression.station))
#17
sum(is.na(data$GÃ.opotentiel))
#18
sum(is.na(data$Variation.de.pression.en.24.heures))
#19
sum(is.na(data$TempÃ.rature.minimale.sur.12.heures))
#20
sum(is.na(data$TempÃ.rature.maximale.sur.12.heures))
#21
sum(is.na(data$TempÃ.rature.minimale.du.sol.sur.12.heures))
#22
sum(is.na(data$Rafale.sur.les.10.derniÃ.res.minutes))
#23
sum(is.na(data$Rafales.sur.une.pÃ.riode))
#24
sum(is.na(data$Periode.de.mesure.de.la.rafale))
#25
sum(is.na(data$Etat.du.sol))
#26
sum(is.na(data$Hauteur.de.la.neige.fraÃ.che))
#27
sum(is.na(data$Periode.de.mesure.de.la.neige.fraiche))
#28
sum(is.na(data$PrÃ.cipitations.dans.la.derniÃ.re.heure))
#29
sum(is.na(data$PrÃ.cipitations.dans.les.3.derniÃ.res.heures))
#30
sum(is.na(data$PrÃ.cipitations.dans.les.6.derniÃ.res.heures))
#31
sum(is.na(data$PrÃ.cipitations.dans.les.12.derniÃ.res.heures))
#32
sum(is.na(data$PrÃ.cipitations.dans.les.24.derniÃ.res.heures))
#33
sum(is.na(data$PhÃ.nomÃ.ne.spÃ.cial.1))
#34
sum(is.na(data$PhÃ.nomÃ.ne.spÃ.cial.2))
#35
sum(is.na(data$PhÃ.nomÃ.ne.spÃ.cial.3))
#36
sum(is.na(data$PhÃ.nomÃ.ne.spÃ.cial.4))
#37
sum(is.na(data$NÃ.bulositÃ..couche.nuageuse.1))
#38
sum(is.na(data$Type.nuage.1))
#39
sum(is.na(data$Hauteur.de.base.1))
#40
sum(is.na(data$NÃ.bulositÃ..couche.nuageuse.2))
#41
sum(is.na(data$Type.nuage.2))
#42
sum(is.na(data$NÃ.bulositÃ..couche.nuageuse.3))
#43
sum(is.na(data$Type.nuage.3))
#44
sum(is.na(data$Hauteur.de.base.3))
#45
sum(is.na(data$Type.nuage.4))
#46
#sum(is.na(data$Temps.prÃ.sent.1))
#47
sum(is.na(data$TempÃ.rature..Â.C.))
#48
sum(is.na(data$TempÃ.rature.minimale.sur.12.heures..Â.C.))
#49
sum(is.na(data$TempÃ.rature.maximale.sur.12.heures..Â.C.))
#50
sum(is.na(data$TempÃ.rature.maximale.sur.24.heures..Â.C.))
#51
sum(is.na(data$TempÃ.rature.minimale.du.sol.sur.12.heures..en.Â.C.))
#52
sum(is.na(data$Altitude))
#53
sum(is.na(data$mois_de_l_annee))

```
On en déduit cela
plus 20 000 manquants: 
$Type.des.nuages.de.l.Ã.tage.infÃ.rieur
$Type.des.nuages.de.l.Ã.tage.moyen
$Type.des.nuages.de.l.Ã.tage.supÃ.rieur
$GÃ.opotentiel
$TempÃ.rature.minimale.sur.12.heures
$TempÃ.rature.maximale.sur.12.heures
$Hauteur.de.la.neige.fraÃ.che
$Periode.de.mesure.de.la.neige.fraiche
$PhÃ.nomÃ.ne.spÃ.cial.1
$PhÃ.nomÃ.ne.spÃ.cial.2
$PhÃ.nomÃ.ne.spÃ.cial.3
$PhÃ.nomÃ.ne.spÃ.cial.4
$Type.nuage.1
$Hauteur.de.base.1
$NÃ.bulositÃ..couche.nuageuse.2
$Type.nuage.2
$NÃ.bulositÃ..couche.nuageuse.3
$Type.nuage.3
$Hauteur.de.base.3
$Type.nuage.4
$TempÃ.rature.minimale.sur.12.heures..Â.C.
$TempÃ.rature.maximale.sur.12.heures..Â.C.
$TempÃ.rature.maximale.sur.24.heures..Â.C.

 plus de 10 000:
$NebulositÃ..totale
$Hauteur.de.la.base.des.nuages.de.l.Ã.tage.infÃ.rieur
$Variation.de.pression.en.24.heures
$TempÃ.rature.minimale.du.sol.sur.12.heures
$Rafale.sur.les.10.derniÃ.res.minutes
$Etat.du.sol
$PrÃ.cipitations.dans.les.6.derniÃ.res.heures
$PrÃ.cipitations.dans.les.12.derniÃ.res.heures
$PrÃ.cipitations.dans.les.24.derniÃ.res.heures
$NÃ.bulositÃ..couche.nuageuse.1
$TempÃ.rature.minimale.du.sol.sur.12.heures..en.Â.C.

plus de 5000:
$NÃ.bulositÃ...des.nuages.de.l..Ã.tage.infÃ.rieur

Suppression des plus de 20 000
```{r}
data$Type.des.nuages.de.l.Ã.tage.infÃ.rieur <- NULL
data$Type.des.nuages.de.l.Ã.tage.moyen <- NULL
data$Type.des.nuages.de.l.Ã.tage.supÃ.rieur <- NULL
data$GÃ.opotentiel <- NULL
data$TempÃ.rature.minimale.sur.12.heures <- NULL
data$TempÃ.rature.maximale.sur.12.heures <- NULL
data$Hauteur.de.la.neige.fraÃ.che <- NULL
data$Periode.de.mesure.de.la.neige.fraiche <- NULL
data$PhÃ.nomÃ.ne.spÃ.cial.1 <- NULL
data$PhÃ.nomÃ.ne.spÃ.cial.2 <- NULL
data$PhÃ.nomÃ.ne.spÃ.cial.3 <- NULL
data$PhÃ.nomÃ.ne.spÃ.cial.4 <- NULL
data$Type.nuage.1 <- NULL
data$Hauteur.de.base.1 <- NULL
data$NÃ.bulositÃ..couche.nuageuse.2 <- NULL
data$Type.nuage.2 <- NULL
data$NÃ.bulositÃ..couche.nuageuse.3 <- NULL
data$Type.nuage.3 <- NULL
data$Hauteur.de.base.3 <- NULL
data$Type.nuage.4 <- NULL
data$TempÃ.rature.minimale.sur.12.heures..Â.C. <- NULL
data$TempÃ.rature.maximale.sur.12.heures..Â.C. <- NULL
data$TempÃ.rature.maximale.sur.24.heures..Â.C. <- NULL




```

Il s'agit d'une conversion de Kelvin en celsius, cette ligne n'a pas d'utilité
```{r}
data$TempÃ.rature..Â.C. <- NULL
```


Nous sommes alors à 32 variables
Mais combien si l'on retire les lignes avec des manquants ?



```{r, results='hide'}
which(is.na(data))
data <- na.omit(data)
```


On créé une colonne DateEnJour afin que chaque jour est son numéro
```{r}
#library(dplyr)
#df %>% 
#  slice(which.max(as.Date(data$Date)))

data$jour = format(as.Date(data$Date,format="%Y-%m-%d"), format = "%d")
data$mois = ( format(as.Date(data$Date,format="%Y-%m-%d"), format = "%m"))
data$annee = format(as.Date(data$Date,format="%Y-%m-%d"), format = "%Y")

#multiplieur 
#c'était un problème de classe de donnée
#data$trente <- replicate(4965, 30)
#data$troisCent <- replicate(4965, 365)

data$jour <- as.numeric(data$jour)
data$mois <- as.numeric(data$mois)
data$annee <- as.numeric(data$annee)



data$DateEnJour <- data$jour + (30 *data$mois) + ( 365*data$annee)

```



On ne garde que une observation par jour pour un jeu de prévision 
en effet le nbre d'observation par jour est irrégulier.
```{r}

prevision <- do.call(rbind, by(data, list(data$DateEnJour), 
                  FUN=function(x) head(x, 1)))

```

On supprimme les variables créé et la date
```{r}
data$Date <- NULL
data$DateEnJour <- NULL
data$annee <- NULL
data$mois <- NULL
data$jour <- NULL

prevision$Date <- NULL
prevision$DateEnJour <- NULL
prevision$annee <- NULL
prevision$mois <- NULL
prevision$jour <- NULL



```
Nous avons désormais deux jeux pour réaliser une régression linéaire,
le premier avec 5661 observations , le second avec une observation par jour dans le but de déterminer la Température du jour à venir.

Pour le jeu de prévision,
nous creons une colonne température mais décaler de 1 jour.

La première méthode utilisé n'était pas correct puisque l'on décalait dans le mauvais sens la colonne avec la méthode lag,
puis on supprimait la première observation.


```{r}
#Mauvaise méthode
#data$TemperatureDecaler <- lag(data$TempÃ.rature)
#on supprimme la première observation
#data = data[-1,]


library(Hmisc)
#prevision$Precipitation_Jour_Suivant <- Lag(prevision$PrÃ.cipitations.dans.les.24.derniÃ.res.heures, shift = -1)
prevision$Precipitation_Jour_Suivant <- Lag(prevision$TempÃ.rature, shift = -1)
#on supprimme la derniere observation
library(dplyr)
prevision = slice(prevision, 1:(n() -1))


#De même on réduit la taille du nbre d'observation de data
data = slice(data, 1:(n() -662))

```

```{r}
dim(data)
dim(prevision)
```
4999 observations de 21 variables, cela est suffisant pour la régression multiple


## Statistiques Descriptives

Regardons ce qui caractérise cette base de données,
tant au niveau des moyennes, de la variance...

```{r donnee}
summary(data)
```
Nos observations sont complètes, et les variables toutes quantitatives, nous pouvons commencer la régression multiple.


Nous n'avons pas importer en UTF-8 pour économiser de la place, donnons des labels corrects aux colonnes que nous allons utiliser.
```{r}
labels <- c(
  "Pression_Mer",
  "Variation_Pression_3h",
  "Direction_vent",
  "Vitesse_vent",
  "Temperature",
  "Point_de_rosee",
  "Humidite",
  "Visibilite_horizontale",
  "Nebulosite_total",
  "Hauteur_Base_Nuage_Inferieur",
  "Pression_Station",
  "Variation_Pression",
  "Temperature_minimale_sol",
  "Rafales",
  "Rafales_total",
  "Precipitation_1h",
  "Precipitation_3h",
  "Precipitation_6h",
  "Precipitation_12h",
  "Precipitation_24h",
  "Hauteur_Base_Nuage_Superieur"
#  "Precipitation_Jour_Suivant"
            )
names(data) <- labels

label <- c(
  "Pression_Mer",
  "Variation_Pression_3h",
  "Direction_vent",
  "Vitesse_vent",
  "Temperature",
  "Point_de_rosee",
  "Humidite",
  "Visibilite_horizontale",
  "Nebulosite_total",
  "Hauteur_Base_Nuage_Inferieur",
  "Pression_Station",
  "Variation_Pression",
  "Temperature_minimale_sol",
  "Rafales",
  "Rafales_total",
  "Precipitation_1h",
  "Precipitation_3h",
  "Precipitation_6h",
  "Precipitation_12h",
  "Precipitation_24h",
  "Hauteur_Base_Nuage_Superieur",
  "Precipitation_Jour_Suivant"
            )
names(prevision) <- label

```

## Régression multiple avec toutes les variables explicatives

```{r}
reg.mul <- lm(Temperature~.,data)
summary(reg.mul)

```
Les résidus estimés ont une moyenne de 0.

Avant que l'on retire des observations pour atteindre moins de 5000, on observe :
"""
Il nous est indiqué que 3 variables sont significatives, il y en a peu car les variables doivent être très corréllés

Attention, Nous ne pouvons écrire que Temperature du jour suivant = 7.464e-14 + Variation_Pression_3h * -1.321e-18 + Direction_vent *  4.089e-18  ,
il faut refaire le modèle avec uniquement ces variables. 
"""
Ces valeurs ont complètement changer par la modification de l'échantillon, cette régression est totalement dépendante de son échantillon,
le résultat des tests sur les résidus nous confirmera cela. Notre R² de 1 est complètement inutile.


Réalisons les intervalles de confiance
```{r}
confint(reg.mul)
```
Ainsi sur 100 échantillon de mesures météorologiques, 95 seront dans ces valeurs.


histogramme des résidus
```{r}
hist(reg.mul$residuals)
```


tests sur les résidus gaussiens
```{r,echo=TRUE}
#reg.mul$residuals

shapiro.test(reg.mul$residuals)

```
La p-value est inferieur à 5% donc on rejette H0, les Ei ne suivent pas des lois normales (résidus non gaussiens)
les tests de Fisher et Student ne sont pas valables.

Regression sans la Constante
```{r}
reg.mulSansC <- lm(Temperature~.-1,data)
summary(reg.mulSansC)
```


On refait une régression avec les variables significatives
```{r}
#reg.mulfin <- lm(,data)
#summary(reg.mulfin)
```





## Matrice des corrélations des variables explicative

commentaire
```{r}

```

visualisation
```{r}

```

## Régression pas à pas

Ascendant
```{r}

```

Descendant
```{r}

```

Comparaison des résultats des régressions

## ACP

```{r}

```

## Régression Ridge

```{r}

```

## Conclusion



